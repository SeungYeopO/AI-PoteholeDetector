<!DOCTYPE html>
<html>
<head>
    <title>Rotate Map</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAYY_7_SvYIBAR5lAtf84PMm5-keG1z0Gg"></script>
    <script>
        let map, infoWindow;
        let hasOrientationPermission = false;

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: {lat: -34.397, lng: 150.644},
                zoom: 16,
                heading: 0
            });
            infoWindow = new google.maps.InfoWindow;

            // Geolocation
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    infoWindow.setPosition(pos);
                    infoWindow.setContent('Location found.');
                    infoWindow.open(map);
                    map.setCenter(pos);
                }, function() {
                    handleLocationError(true, infoWindow, map.getCenter());
                });
            } else {
                handleLocationError(false, infoWindow, map.getCenter());
            }

            // Request permission for device orientation
            requestOrientationPermission();
        }

        function handleOrientationPermission(status) {
            if (status === 'granted') {
                hasOrientationPermission = true;
                // Listen for orientation changes
                window.addEventListener('deviceorientation', handleDeviceOrientation);
            } else {
                alert("Permission denied for device orientation.");
            }
        }

        function requestOrientationPermission() {
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(handleOrientationPermission);
            } else {
                alert("Device orientation permissions not supported in this browser.");
            }
        }

        function handleDeviceOrientation(event) {
            if (!hasOrientationPermission) return;

            let alpha = event.alpha;
            if (typeof event.webkitCompassHeading !== 'undefined') {
                alpha = event.webkitCompassHeading;
                map.setHeading(360 - alpha);
            } else {
                const mapHeading = 360 - alpha;
                map.setHeading(mapHeading);
            }
        }

        function handleLocationError(browserHasGeolocation, infoWindow, pos) {
            infoWindow.setPosition(pos);
            infoWindow.setContent(browserHasGeolocation ?
                                  'Error: The Geolocation service failed.' :
                                  'Error: Your browser doesn\'t support geolocation.');
            infoWindow.open(map);
        }
    </script>
</head>
<body>
    <div id="map" style="height: 500px; width: 100%;"></div>
    <script>
        initMap();
    </script>
</body>
</html>
